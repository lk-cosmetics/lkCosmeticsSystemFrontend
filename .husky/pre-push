#!/bin/sh
echo "ğŸš€ Running pre-push checks..."

# Check if any source files changed since last push
CHANGED_FILES=$(git diff --name-only @{push}..HEAD 2>/dev/null || git diff --name-only HEAD~1..HEAD)
SOURCE_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json)$' || true)

if [ -z "$SOURCE_CHANGED" ]; then
  echo "ğŸ“¦ No source files changed, skipping checks"
  exit 0
fi

echo "ğŸ“¦ Source files changed, running full codebase checks..."

# Step 1: Run ESLint with auto-fix
echo "ğŸ” Running ESLint with auto-fix..."
npm run lint:fix
if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed! Please fix remaining linting errors manually before pushing."
  exit 1
fi
echo "âœ… ESLint passed (auto-fixed issues where possible)!"

# Step 2: Run Prettier to auto-format
echo "ğŸ’… Running Prettier to auto-format code..."
npm run format:all
if [ $? -ne 0 ]; then
  echo "âŒ Prettier formatting failed!"
  exit 1
fi
echo "âœ… Code formatted successfully!"

# Step 3: Check if there are any changes after auto-fixes
CHANGES_AFTER_FIX=$(git diff --name-only)
if [ -n "$CHANGES_AFTER_FIX" ]; then
  echo "ğŸ“ Auto-fixes were applied. Staging changes..."
  git add .
  echo "âœ¨ Changes have been staged. You may want to review them before pushing."
fi

# Step 4: Run TypeScript type checking
echo "ğŸ” Running TypeScript type check..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed! Please fix type errors before pushing."
  exit 1
fi
echo "âœ… TypeScript type check passed!"

# Step 5: Run build
echo "ğŸ—ï¸  Running build..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed! Please fix build errors before pushing."
  exit 1
fi
echo "âœ… Build check passed!"

echo "ğŸ‰ All pre-push checks passed successfully!"
